name: Build aVPN

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        lfs: true
    
    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-gnutls
          mingw-w64-x86_64-qt5-base
          mingw-w64-x86_64-qt5-tools
          mingw-w64-x86_64-qt5-svg
          mingw-w64-x86_64-pkgconf
          mingw-w64-x86_64-libxml2
          mingw-w64-x86_64-zlib
          mingw-w64-x86_64-jq
          mingw-w64-x86_64-nsis
          autoconf
          automake
          libtool
          make
          git
    
    - name: Build and Install spdlog
      shell: msys2 {0}
      run: |
        git clone https://github.com/gabime/spdlog.git
        cd spdlog
        git checkout v1.3.1
        mkdir build && cd build
        cmake .. -G "MSYS Makefiles" -DCMAKE_INSTALL_PREFIX=/mingw64 -DCMAKE_POLICY_VERSION_MINIMUM=3.5 -DSPDLOG_BUILD_EXAMPLE=OFF -DSPDLOG_BUILD_BENCH=OFF -DSPDLOG_BUILD_TESTS=OFF
        make -j4 install
    
    - name: Build and Install OpenConnect
      shell: msys2 {0}
      run: |
        curl -o /tmp/vpnc-script https://gitlab.com/openconnect/vpnc-scripts/-/raw/master/vpnc-script
        chmod +x /tmp/vpnc-script
        
        git clone https://gitlab.com/openconnect/openconnect.git
        cd openconnect
        ./autogen.sh
        ./configure \
          --prefix=/mingw64 \
          --disable-nls \
          --disable-dependency-tracking \
          --without-gnutls-version-check \
          --with-vpnc-script=/tmp/vpnc-script
        make -j4
        make install
    
    - name: Configure CMake
      shell: msys2 {0}
      run: |
        export PATH=/mingw64/bin:$PATH
        mkdir build
        cd build
        cmake .. \
          -G "MSYS Makefiles" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_PREFIX_PATH=/mingw64 \
          -DCMAKE_C_COMPILER=/mingw64/bin/gcc.exe \
          -DCMAKE_CXX_COMPILER=/mingw64/bin/g++.exe \
          -DPROJ_INI_SETTINGS=ON \
          -DCMAKE_DISABLE_FIND_PACKAGE_OpenConnect=OFF
    
    - name: Build aVPN
      shell: msys2 {0}
      run: |
        cd build
        make -j4
    
    - name: Create Windows Installer
      shell: msys2 {0}
      run: |
        cd build/bin
        
        echo "=== Copying all MinGW64 DLLs ==="
        ldd avpn.exe | grep mingw64 | awk '{print $3}' | while read dll; do
          echo "Copying: $dll"
          cp -v "$dll" . || true
        done
        
        echo "=== Ensuring critical runtime DLLs ==="
        cp -v /mingw64/bin/libgcc_s_seh-1.dll . || true
        cp -v /mingw64/bin/libstdc++-6.dll . || true
        cp -v /mingw64/bin/libwinpthread-1.dll . || true
        
        echo "=== Copying Qt DLLs ==="
        cp -v /mingw64/bin/Qt5Core.dll . || true
        cp -v /mingw64/bin/Qt5Gui.dll . || true
        cp -v /mingw64/bin/Qt5Widgets.dll . || true
        cp -v /mingw64/bin/Qt5Network.dll . || true
        cp -v /mingw64/bin/Qt5Svg.dll . || true
        
        echo "=== Copying other dependencies ==="
        cp -v /mingw64/bin/libgnutls-30.dll . || true
        cp -v /mingw64/bin/libopenconnect-5.dll . || true
        cp -v /mingw64/bin/libxml2-*.dll . || true
        cp -v /mingw64/bin/zlib1.dll . || true
        cp -v /mingw64/bin/libp11-kit-0.dll . || true
        cp -v /mingw64/bin/libnettle-*.dll . || true
        cp -v /mingw64/bin/libhogweed-*.dll . || true
        cp -v /mingw64/bin/libgmp-*.dll . || true
        cp -v /mingw64/bin/libiconv-*.dll . || true
        cp -v /mingw64/bin/liblzma-*.dll . || true
        cp -v /mingw64/bin/libffi-*.dll . || true
        cp -v /mingw64/bin/libbrotlidec.dll . || true
        cp -v /mingw64/bin/libbrotlicommon.dll . || true
        cp -v /mingw64/bin/libpcre2-16-0.dll . || true
        cp -v /mingw64/bin/libzstd.dll . || true
        cp -v /mingw64/bin/libdouble-conversion.dll . || true
        cp -v /mingw64/bin/libicuin*.dll . || true
        cp -v /mingw64/bin/libicuuc*.dll . || true
        cp -v /mingw64/bin/libicudt*.dll . || true
        cp -v /mingw64/bin/libharfbuzz-0.dll . || true
        cp -v /mingw64/bin/libfreetype-6.dll . || true
        cp -v /mingw64/bin/libpng16-16.dll . || true
        cp -v /mingw64/bin/libbz2-1.dll . || true
        cp -v /mingw64/bin/libglib-2.0-0.dll . || true
        cp -v /mingw64/bin/libgraphite2.dll . || true
        cp -v /mingw64/bin/libintl-8.dll . || true
        cp -v /mingw64/bin/libpcre2-8-0.dll . || true
        
        echo "=== Creating Qt plugins directory ==="
        mkdir -p plugins/platforms
        cp -v /mingw64/share/qt5/plugins/platforms/qwindows.dll plugins/platforms/ || true
        
        mkdir -p plugins/styles
        cp -v /mingw64/share/qt5/plugins/styles/*.dll plugins/styles/ || true
        
        echo "=== Final DLL list in bin directory ==="
        ls -la *.dll
        
        cd ..
        make package
    
    - name: Package Windows
      shell: msys2 {0}
      run: |
        cd build
        ls -la *.exe || echo "No installer found in build directory"
    
    - name: Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: avpn-windows-installer
        path: build/avpn-*.exe
        retention-days: 7

  build-linux:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Convert Windows Icon to Linux PNG
      run: |
        sudo apt-get update
        sudo apt-get install -y imagemagick
        
        echo "=== Converting Windows ICO to Linux PNG ==="
        convert src/avpn.ico[0] -resize 300x300 src/Resources/mono_lock.png
        ls -lh src/Resources/mono_lock.png
        file src/Resources/mono_lock.png
    
    - name: Install Dependencies
      run: |
        sudo apt-get install -y \
          cmake \
          build-essential \
          qtbase5-dev \
          qttools5-dev \
          qttools5-dev-tools \
          libqt5svg5-dev \
          libopenconnect-dev \
          libgnutls28-dev \
          pkg-config \
          git
    
    - name: Install spdlog
      run: |
        git clone https://github.com/gabime/spdlog.git
        cd spdlog
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        sudo make -j$(nproc) install
    
    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
    
    - name: Build
      run: |
        cd build
        make -j$(nproc)
        
        echo "=== Checking built executable ==="
        ls -lh src/avpn || ls -lh bin/avpn || true
        ldd src/avpn || ldd bin/avpn || true
    
    - name: Create Linux Package
      run: |
        cd build
        
        # Find the executable
        if [ -f src/avpn ]; then
          AVPN_EXE=src/avpn
        elif [ -f bin/avpn ]; then
          AVPN_EXE=bin/avpn
        else
          echo "Error: Cannot find avpn executable"
          find . -name "avpn" -type f
          exit 1
        fi
        
        echo "=== Executable info ==="
        ls -lh $AVPN_EXE
        ldd $AVPN_EXE
        
        # Create simple package with all dependencies
        mkdir -p package/bin
        mkdir -p package/lib
        
        # Copy executable
        cp -v $AVPN_EXE package/bin/avpn
        chmod +x package/bin/avpn
        
        # Copy all Qt libraries
        echo "=== Copying Qt libraries ==="
        for qtlib in Qt5Core Qt5Gui Qt5Widgets Qt5Network Qt5Svg Qt5DBus; do
          find /usr/lib -name "lib${qtlib}.so*" -exec cp -v {} package/lib/ \; 2>/dev/null || true
        done
        
        # Copy other dependencies
        echo "=== Copying dependencies ==="
        ldd $AVPN_EXE | grep "=>" | awk '{print $3}' | while read lib; do
          if [ -n "$lib" ] && [ -f "$lib" ]; then
            # Copy non-system libraries
            case "$lib" in
              /lib/x86_64-linux-gnu/*|/lib64/*|/usr/lib/x86_64-linux-gnu/libc.so*|/usr/lib/x86_64-linux-gnu/libm.so*|/usr/lib/x86_64-linux-gnu/libpthread.so*|/usr/lib/x86_64-linux-gnu/libdl.so*)
                # Skip basic system libraries
                ;;
              *)
                echo "Copying: $lib"
                cp -v "$lib" package/lib/ 2>/dev/null || true
                ;;
            esac
          fi
        done
        
        # Copy Qt plugins
        echo "=== Copying Qt plugins ==="
        mkdir -p package/plugins/platforms
        mkdir -p package/plugins/platformthemes
        cp -v /usr/lib/x86_64-linux-gnu/qt5/plugins/platforms/libqxcb.so package/plugins/platforms/ 2>/dev/null || true
        cp -v /usr/lib/x86_64-linux-gnu/qt5/plugins/platformthemes/libqgtk*.so package/plugins/platformthemes/ 2>/dev/null || true
        
        # Create launch script
        cat > package/avpn.sh << 'LAUNCHEOF'
        #!/bin/bash
        DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        export LD_LIBRARY_PATH="${DIR}/lib:${LD_LIBRARY_PATH}"
        export QT_PLUGIN_PATH="${DIR}/plugins"
        export QT_QPA_PLATFORM_PLUGIN_PATH="${DIR}/plugins/platforms"
        exec "${DIR}/bin/avpn" "$@"
        LAUNCHEOF
        chmod +x package/avpn.sh
        
        # Create README
        cat > package/README.txt << 'READMEEOF'
        aVPN for Linux
        
        To run: ./avpn.sh
        Or install to /opt: sudo cp -r . /opt/avpn && sudo ln -s /opt/avpn/avpn.sh /usr/local/bin/avpn
        READMEEOF
        
        echo "=== Package contents ==="
        du -sh package
        find package -type f | head -20
        
        # Create tar.gz
        tar -czf avpn-linux-x64.tar.gz -C package .
        ls -lh avpn-linux-x64.tar.gz
    
    - name: Upload Linux Artifact
      uses: actions/upload-artifact@v4
      with:
        name: avpn-linux-x64
        path: build/avpn-linux-x64.tar.gz
        retention-days: 7

  build-macos:
    runs-on: macos-13
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Convert Windows Icon to macOS ICNS
      run: |
        echo "=== Converting Windows ICO to macOS ICNS ==="
        
        # 安装 ImageMagick 和 libicns
        brew install imagemagick libicns
        
        # 创建 iconset 目录
        mkdir -p src/Resources/mono_lock.iconset
        
        # 从 ICO 提取主图标并生成各种尺寸
        for size in 16 32 128 256 512; do
          echo "Generating ${size}x${size}..."
          convert src/avpn.ico[0] -resize ${size}x${size} src/Resources/mono_lock.iconset/icon_${size}x${size}.png
          
          # 生成 @2x 版本（除了 512 之外）
          if [ $size -lt 512 ]; then
            size2x=$((size * 2))
            convert src/avpn.ico[0] -resize ${size2x}x${size2x} src/Resources/mono_lock.iconset/icon_${size}x${size}@2x.png
          fi
        done
        
        # 生成 1024x1024 for 512x512@2x
        convert src/avpn.ico[0] -resize 1024x1024 src/Resources/mono_lock.iconset/icon_512x512@2x.png
        
        # 使用 iconutil 生成 .icns 文件
        iconutil -c icns src/Resources/mono_lock.iconset -o src/Resources/mono_lock.icns
        
        echo "=== Generated ICNS file ==="
        ls -lh src/Resources/mono_lock.icns
        file src/Resources/mono_lock.icns
        
        # 清理 iconset 目录
        rm -rf src/Resources/mono_lock.iconset
    
    - name: Install Dependencies
      run: |
        brew install qt@5 openconnect gnutls cmake pkg-config fmt
    
    - name: Download vpnc-script
      run: |
        echo "=== Downloading vpnc-script ==="
        curl -L -o src/Resources/vpnc-script https://gitlab.com/openconnect/vpnc-scripts/-/raw/master/vpnc-script
        chmod +x src/Resources/vpnc-script
        ls -lh src/Resources/vpnc-script
        head -5 src/Resources/vpnc-script
    
    - name: Configure CMake
      run: |
        export Qt5_DIR=$(brew --prefix qt@5)/lib/cmake/Qt5
        export PKG_CONFIG_PATH=$(brew --prefix openconnect)/lib/pkgconfig:$(brew --prefix gnutls)/lib/pkgconfig
        
        # Find vpnc-script location
        VPNC_SCRIPT_PATH="$(pwd)/src/Resources/vpnc-script"
        echo "VPNC_SCRIPT_PATH=$VPNC_SCRIPT_PATH"
        
        mkdir build
        cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_PREFIX_PATH=$(brew --prefix qt@5) \
          -DCMAKE_OSX_DEPLOYMENT_TARGET=10.15 \
          -DOPENCONNECT_VPNC_SCRIPT="$VPNC_SCRIPT_PATH"
    
    - name: Build
      run: |
        cd build
        make -j$(sysctl -n hw.ncpu) 2>&1 | tee build.log
        
        echo "=== Build completed, checking result ==="
        find . -name "*.app" -type d
        find . -name "aVPN" -o -name "avpn" | grep -v autogen
        
        # Check if executable exists in .app bundle
        APP_PATH=$(find . -name "*.app" -type d | head -1)
        if [ -n "$APP_PATH" ]; then
          echo "=== Checking app bundle structure ==="
          ls -lR "$APP_PATH"
        fi
    
    - name: Create App Bundle
      run: |
        cd build
        
        echo "=== Locating .app bundle ==="
        find . -name "*.app" -type d
        
        APP_PATH=$(find . -name "*.app" -type d | head -1)
        
        if [ -z "$APP_PATH" ]; then
          echo "Error: Cannot find .app bundle"
          find . -type f -name "aVPN" -o -name "avpn"
          exit 1
        fi
        
        echo "Found app bundle at: $APP_PATH"
        echo "=== Initial app size ==="
        du -sh "$APP_PATH"
        ls -lah "$APP_PATH/Contents/MacOS/"
        
        # Get directory containing the .app
        APP_DIR=$(dirname "$APP_PATH")
        APP_NAME=$(basename "$APP_PATH")
        
        echo "=== App bundle initial structure ==="
        find "$APP_PATH" -type f -exec ls -lh {} \; | head -20
        
        # Go to app directory
        cd "$APP_DIR"
        
        # Run macdeployqt to bundle dependencies
        echo "=== Running macdeployqt ==="
        QT_BIN=$(brew --prefix qt@5)/bin
        
        # Use macdeployqt with explicit paths
        "$QT_BIN/macdeployqt" "$APP_NAME" \
          -always-overwrite \
          -verbose=3 \
          2>&1 | tee macdeployqt.log
        
        echo "=== After macdeployqt - checking size ==="
        du -sh "$APP_NAME"
        
        # Fix library paths to use @rpath instead of hardcoded Homebrew paths
        echo "=== Fixing dynamic library paths ==="
        FRAMEWORKS_DIR="$APP_NAME/Contents/Frameworks"
        
        if [ -d "$FRAMEWORKS_DIR" ]; then
          echo "Found Frameworks directory, fixing library paths..."
          
          # Fix all dylib files in Frameworks
          find "$FRAMEWORKS_DIR" -name "*.dylib" | while read dylib; do
            echo "Processing: $dylib"
            
            # Get all dependencies with absolute paths
            otool -L "$dylib" | grep -E '/usr/local|/opt/homebrew' | awk '{print $1}' | while read dep; do
              libname=$(basename "$dep")
              echo "  Fixing dependency: $dep -> @rpath/$libname"
              install_name_tool -change "$dep" "@rpath/$libname" "$dylib" 2>/dev/null || true
            done
            
            # Also fix the dylib's own install name if needed
            install_name=$(otool -D "$dylib" | tail -1)
            if [[ "$install_name" == /usr/local/* ]] || [[ "$install_name" == /opt/homebrew/* ]]; then
              libname=$(basename "$dylib")
              echo "  Fixing install name: $install_name -> @rpath/$libname"
              install_name_tool -id "@rpath/$libname" "$dylib" 2>/dev/null || true
            fi
          done
          
          # Fix the main executable
          EXEC_PATH="$APP_NAME/Contents/MacOS/aVPN"
          if [ -f "$EXEC_PATH" ]; then
            echo "Fixing main executable: $EXEC_PATH"
            
            # Add @rpath search paths
            echo "  Adding @rpath entries..."
            install_name_tool -add_rpath "@executable_path/../Frameworks" "$EXEC_PATH" 2>/dev/null || true
            install_name_tool -add_rpath "@loader_path/../Frameworks" "$EXEC_PATH" 2>/dev/null || true
            
            # Fix dependencies
            otool -L "$EXEC_PATH" | grep -E '/usr/local|/opt/homebrew' | awk '{print $1}' | while read dep; do
              libname=$(basename "$dep")
              echo "  Fixing dependency: $dep -> @rpath/$libname"
              install_name_tool -change "$dep" "@rpath/$libname" "$EXEC_PATH" 2>/dev/null || true
            done
          fi
          
          # Also add @rpath to all dylibs so they can find each other
          find "$FRAMEWORKS_DIR" -name "*.dylib" | while read dylib; do
            install_name_tool -add_rpath "@loader_path" "$dylib" 2>/dev/null || true
            install_name_tool -add_rpath "@loader_path/." "$dylib" 2>/dev/null || true
          done
          
          echo "=== Verification: Checking for remaining absolute paths ==="
          find "$FRAMEWORKS_DIR" -name "*.dylib" -exec otool -L {} \; | grep -E '/usr/local|/opt/homebrew' || echo "No hardcoded paths found - Good!"
          
          if [ -f "$EXEC_PATH" ]; then
            echo "Main executable dependencies:"
            otool -L "$EXEC_PATH" | grep -E '/usr/local|/opt/homebrew' || echo "No hardcoded paths in executable - Good!"
          fi
        else
          echo "Warning: Frameworks directory not found"
        fi
        
        echo "=== Checking bundled frameworks ==="
        ls -lh "$APP_NAME/Contents/Frameworks/" 2>/dev/null || echo "No Frameworks directory"
        find "$APP_NAME/Contents/Frameworks" -name "*.framework" 2>/dev/null || true
        
        echo "=== Checking bundled plugins ==="
        ls -lh "$APP_NAME/Contents/PlugIns/" 2>/dev/null || echo "No PlugIns directory"
        
        echo "=== Total files in bundle ==="
        find "$APP_NAME" -type f | wc -l
        
        # Create temporary directory for DMG
        DMG_NAME="${APP_NAME%.app}"
        mkdir -p dmg_temp
        cp -R "$APP_NAME" dmg_temp/
        
        # Create DMG with better settings
        echo "=== Creating DMG ==="
        hdiutil create \
          -volname "aVPN" \
          -srcfolder dmg_temp \
          -ov \
          -format UDZO \
          -imagekey zlib-level=9 \
          "$DMG_NAME.dmg"
        
        echo "=== DMG created ==="
        ls -lh "$DMG_NAME.dmg"
        file "$DMG_NAME.dmg"
        
        # Verify DMG content
        echo "=== Verifying DMG content ==="
        hdiutil attach "$DMG_NAME.dmg" -readonly -mountpoint /tmp/avpn_verify
        ls -lh /tmp/avpn_verify/
        du -sh /tmp/avpn_verify/*.app
        hdiutil detach /tmp/avpn_verify
    
    - name: Upload macOS Artifact
      uses: actions/upload-artifact@v4
      with:
        name: avpn-macos-x64
        path: build/**/*.dmg
        retention-days: 7